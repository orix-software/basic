os: linux

language: c

addons:
        apt:
                update: true
                packages:
                        - curl
                        - python3

install:
    - sudo pip install --upgrade pip
    - pip install pathlib
    - pip install pycurl    
    - pushd tools && git clone https://github.com/assinie/md2hlp.git
    - popd
    - git clone --branch xa-2.3.10 https://github.com/fachat/xa65.git
    - pushd xa65/xa && make &> /dev/null
    - cp file65 ldo65 reloc65 xa /home/travis/bin
    - popd

script:
    - HOBBIT=yes make && make clean && GAMES=yes make && make clean && make
    - USB_MODE=usb HOBBIT=yes make && make clean && USB_MODE=usb GAMES=yes make && make clean && USB_MODE=usb make

after_success:
    - VERSION=`cat VERSION`
    - mkdir orix/usr/share/basic/$VERSION -p && cp build/cart/basic*.rom orix/usr/share/basic/$VERSION/
    - mkdir -p orix/etc/orixcfg/$VERSION/ && echo "Basicsd Hobbit v$VERSION sd;/usr/share/basic/$VERSION/basicsd0.rom" > orix/etc/orixcfg/$VERSION/basic.cnf
    - mkdir -p orix/usr/share/basic/0/
    - mkdir -p orix/usr/share/basic/1/
    - mkdir -p orix/usr/share/basic/2/    
    - echo "Basicsd Games v$VERSION joy/sd;/usr/share/basic/$VERSION/basicsd.rom" >> orix/etc/orixcfg/$VERSION/basic.cnf
    - echo "Basicsd v$VERSION joy/sd;/usr/share/basic/$VERSION/basicsd.rom" >> orix/etc/orixcfg/$VERSION/basic.cnf
    - echo "Basicusb Hobbit v$VERSION usb;/usr/share/basic/$VERSION/basicus0.rom" > orix/etc/orixcfg/$VERSION/basic.cnf
    - echo "Basicusb Games v$VERSION joy/usb;/usr/share/basic/$VERSION/basicus1.rom" >> orix/etc/orixcfg/$VERSION/basic.cnf
    - echo "Basicusb v$VERSION joy/usb;/usr/share/basic/$VERSION/basicus2.rom" >> orix/etc/orixcfg/$VERSION/basic.cnf
    - python -V
    - cd tools && python3 retrieveSoftwareOricOrg.py && cd ..
    - ls
    - cd tools && builddocs.sh && cd ..
    - cd orix && tar -zcvf ../basic.tgz * && cd ..
    - curl -X POST --data-binary '@basic.tgz' "https://cdn.oric.org/publish.php?hash=$hash&path=/home/oricoujr/www/ftp/orix/dists/$VERSION/tgz/6502/basic.tgz"
